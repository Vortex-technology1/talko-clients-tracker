<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TALKO CRM</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2322c55e' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>T</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAOmGZTwlC820Eh7axijcIFt0SPCmpEquc",
      authDomain: "talko-clients-tracker.firebaseapp.com",
      projectId: "talko-clients-tracker",
      storageBucket: "talko-clients-tracker.firebasestorage.app",
      messagingSenderId: "1048160665282",
      appId: "1:1048160665282:web:c28486793cfc6bc0a3455b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // State
    let currentUser = null;
    let clients = [];
    let expenses = [];
    let activeTab = 'clients';
    let showForm = false;
    let showExpenseForm = false;
    let editingClient = null;
    let editingExpense = null;
    let viewingClient = null;
    let filterType = '';
    let filterStatus = '';
    let filterSearch = '';
    let filterMonth = '';
    let filterClientStatus = 'active'; // default show only active
    let filterNewClients = false; // filter for new clients this month
    let showSettings = false;
    let settings = { monthlyPlan: 0, yearlyPlan: 0 };
    let unsubSettings = null;
    let unsubClients = null;
    let unsubExpenses = null;

    // SVG Icons
    const icons = {
      logo: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="4"/><path d="M9 12h6M12 9v6"/></svg>`,
      plus: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>`,
      edit: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
      trash: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>`,
      close: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>`,
      search: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>`,
      calendar: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>`,
      euro: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8.5a6.5 6.5 0 00-11-4.7M18 15.5a6.5 6.5 0 01-11 4.7M4 10h10M4 14h10"/></svg>`,
      check: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>`,
      clock: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
      wallet: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 4H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V6a2 2 0 00-2-2zM1 10h22"/></svg>`,
      repeat: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>`,
      list: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>`,
      gift: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v10H4V12M2 7h20v5H2zM12 22V7M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7zM12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>`,
      creditCard: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>`,
      phone: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>`,
      mail: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>`,
      send: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>`,
      building: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1"/><path d="M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>`,
      mapPin: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
      chart: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>`,
      alertCircle: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>`,
      pause: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`,
      google: `<svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>`,
      logout: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>`,
      ads: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 4v16M12 4v16M5 8v8M22 8l-7 4 7 4V8zM2 12h3"/></svg>`,
      software: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>`,
      salary: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>`,
      office: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1"/><path d="M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>`,
      taxes: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M4 20V8l8-6 8 6v12"/><path d="M9 20v-6h6v6M9 10h6"/></svg>`,
      education: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>`,
      travel: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16v-2a4 4 0 00-4-4H5"/><path d="M17 6l4 4-4 4"/><path d="M3 8v2a4 4 0 004 4h12"/><path d="M7 18l-4-4 4-4"/></svg>`,
      box: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>`,
      download: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>`,
      star: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
    };

    // Client types
    const clientTypes = {
      regular: { label: 'Регулярний', icon: icons.repeat, color: 'blue', description: 'Платить щомісяця' },
      installment: { label: 'Розтермінування', icon: icons.list, color: 'purple', description: 'Графік платежів' },
      prepaid: { label: 'Передоплата', icon: icons.creditCard, color: 'green', description: 'Оплатив наперед' },
      deposit: { label: 'Завдаток', icon: icons.gift, color: 'amber', description: 'Чекає на старт' },
    };

    // Client statuses
    const clientStatuses = {
      active: { label: 'Активний', color: 'green', icon: icons.check },
      paused: { label: 'На паузі', color: 'gray', icon: icons.pause, description: 'Невідомо чи повернеться' },
      archived: { label: 'Архів', color: 'gray', icon: icons.box, description: 'Колишній клієнт' },
    };

    // Check if client is on academic leave
    const isOnAcademic = (client) => {
      if (!client.academicFrom) return false;
      const today = getToday();
      const from = client.academicFrom;
      const to = client.academicTo || '2099-12-31';
      return today >= from && today <= to;
    };

    const isMonthOnAcademic = (client, month) => {
      if (!client.academicFrom) return false;
      const from = client.academicFrom.substring(0, 7);
      const to = (client.academicTo || '2099-12').substring(0, 7);
      return month >= from && month <= to;
    };

    // Auto-detect client type for backwards compatibility
    const getClientType = (client) => {
      if (client.type) return client.type;
      // Detect from fields
      if (client.payments && client.payments.length > 0) return 'installment';
      if (client.paymentDay) return 'regular';
      if (client.monthlyAmount) return 'regular';
      if (client.depositAmount !== undefined && client.depositAmount > 0) return 'deposit';
      if (client.startDate && client.endDate) return 'prepaid';
      // Old format - treat as regular if has amount
      if (client.amount) return 'regular';
      return 'regular'; // fallback
    };

    // Get monthly amount for client (handles old and new formats)
    const getClientMonthlyAmount = (client) => {
      if (client.monthlyAmount) return client.monthlyAmount;
      if (client.amount) return client.amount; // old format
      return 0;
    };

    // Get payment day for client
    const getClientPaymentDay = (client) => {
      if (client.paymentDay) return client.paymentDay;
      // Try to extract from date field
      if (client.date) {
        const day = parseInt(client.date.split('-')[2]);
        if (day >= 1 && day <= 31) return day;
      }
      return 18; // default
    };

    // Get client start date (when they became a client)
    const getClientSince = (client) => {
      // Explicit field first
      if (client.clientSince) return client.clientSince;
      // From start date (prepaid/deposit)
      if (client.startDate) return client.startDate;
      // From first payment in history
      if (client.paymentHistory && client.paymentHistory.length > 0) {
        const sorted = [...client.paymentHistory].sort((a, b) => a.month.localeCompare(b.month));
        return sorted[0].month + '-01';
      }
      // From first installment payment
      if (client.payments && client.payments.length > 0) {
        const sorted = [...client.payments].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
        if (sorted[0].date) return sorted[0].date;
      }
      // From old date field
      if (client.date) return client.date;
      // From createdAt
      if (client.createdAt) return client.createdAt.substring(0, 10);
      return null;
    };

    // Check if client is new this month
    const isNewClientThisMonth = (client) => {
      const since = getClientSince(client);
      if (!since) return false;
      const cm = getCurrentMonth();
      return since.startsWith(cm);
    };

    // Check if client is new (within last 30 days)
    const isNewClient = (client) => {
      const since = getClientSince(client);
      if (!since) return false;
      const sinceDate = new Date(since);
      const now = new Date();
      const diffDays = Math.floor((now - sinceDate) / (1000 * 60 * 60 * 24));
      return diffDays <= 30;
    };

    // Get amount paid for a client (handles old and new data formats)
    const getClientPaidAmount = (client, month) => {
      const type = getClientType(client);
      
      if (type === 'regular') {
        // Check paymentHistory first (new format)
        const fromHistory = (client.paymentHistory || []).find(p => p.month === month);
        if (fromHistory) return fromHistory.amount || getClientMonthlyAmount(client);
        // Fallback: check old paidAmount field if date matches
        if (client.paidAmount && client.date?.startsWith(month)) return client.paidAmount;
        return 0;
      }
      
      if (type === 'installment') {
        return (client.payments || [])
          .filter(p => p.paid && p.date?.startsWith(month))
          .reduce((sum, p) => sum + (p.amount || 0), 0);
      }
      
      if (type === 'prepaid') {
        if (client.startDate?.startsWith(month)) return client.totalAmount || client.amount || 0;
        // Old format
        if (client.date?.startsWith(month) && client.paidAmount) return client.paidAmount;
        return 0;
      }
      
      if (type === 'deposit') {
        const depositMonth = client.createdAt?.substring(0, 7) || client.date?.substring(0, 7);
        if (depositMonth === month) return client.depositAmount || client.paidAmount || 0;
        return 0;
      }
      
      // Old format fallback
      if (client.paidAmount && client.date?.startsWith(month)) return client.paidAmount;
      return 0;
    };

    // Check if client payment is marked as paid for current month
    const isClientPaidThisMonth = (client) => {
      const cm = getCurrentMonth();
      const type = getClientType(client);
      
      if (type === 'regular') {
        // New format
        if ((client.paymentHistory || []).some(p => p.month === cm)) return true;
        // Old format: check paidAmount equals amount
        if (client.date?.startsWith(cm) && client.paidAmount > 0) return true;
        return false;
      }
      return false;
    };

    // Service types
    const serviceTypes = [
      { value: 'monthly', label: 'Місячне наставництво' },
      { value: 'consulting_3m', label: '3 місяці консалтингу' },
      { value: 'marketing_2m', label: '2 місяці маркетингу' },
      { value: 'program_3m', label: 'Програма 3 міс' },
      { value: 'franchise', label: 'Франшиза' },
      { value: 'other', label: 'Інше' },
    ];

    // Expense categories
    const expenseCategories = [
      { value: 'ads', label: 'Реклама', icon: 'ads' },
      { value: 'software', label: 'Софт/Підписки', icon: 'software' },
      { value: 'salary', label: 'Зарплати', icon: 'salary' },
      { value: 'office', label: 'Офіс', icon: 'office' },
      { value: 'taxes', label: 'Податки', icon: 'taxes' },
      { value: 'other', label: 'Інше', icon: 'box' },
    ];

    // Helpers
    const getCurrentMonth = () => {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    };

    const getMonthLabel = (monthStr) => {
      if (!monthStr) return '';
      const [year, month] = monthStr.split('-');
      const months = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 
                      'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
      return `${months[parseInt(month) - 1]} ${year}`;
    };

    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}.${month}.${year}`;
    };

    const getToday = () => new Date().toISOString().split('T')[0];

    const getDayOfMonth = (day) => {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    };

    const isDatePast = (dateStr) => {
      if (!dateStr) return false;
      return dateStr < getToday();
    };

    const isDateToday = (dateStr) => dateStr === getToday();

    const daysUntil = (dateStr) => {
      if (!dateStr) return 999;
      const diff = Math.ceil((new Date(dateStr) - new Date(getToday())) / (1000 * 60 * 60 * 24));
      return diff;
    };

    // Get client payment status
    const getClientStatus = (client) => {
      const cm = getCurrentMonth();
      const type = getClientType(client);
      
      // Check academic leave first
      if (isOnAcademic(client)) {
        return { status: 'academic', label: `Академ до ${formatDate(client.academicTo)}`, color: 'gray' };
      }
      
      if (type === 'regular') {
        const paymentDate = getDayOfMonth(client.paymentDay || new Date().getDate());
        const paidThisMonth = isClientPaidThisMonth(client);
        
        if (paidThisMonth) return { status: 'paid', label: 'Оплачено', color: 'green' };
        if (isDatePast(paymentDate)) return { status: 'overdue', label: 'Прострочено', color: 'red' };
        if (isDateToday(paymentDate)) return { status: 'today', label: 'Сьогодні!', color: 'orange' };
        const days = daysUntil(paymentDate);
        if (days <= 3) return { status: 'soon', label: `Через ${days} дн`, color: 'amber' };
        return { status: 'pending', label: formatDate(paymentDate), color: 'gray' };
      }
      
      if (type === 'installment') {
        const nextPayment = (client.payments || []).find(p => !p.paid);
        if (!nextPayment) return { status: 'completed', label: 'Завершено', color: 'green' };
        if (isDatePast(nextPayment.date)) return { status: 'overdue', label: 'Прострочено', color: 'red' };
        if (isDateToday(nextPayment.date)) return { status: 'today', label: 'Сьогодні!', color: 'orange' };
        const days = daysUntil(nextPayment.date);
        if (days <= 7) return { status: 'soon', label: `Через ${days} дн`, color: 'amber' };
        return { status: 'pending', label: formatDate(nextPayment.date), color: 'gray' };
      }
      
      if (type === 'prepaid') {
        if (isDatePast(client.endDate)) return { status: 'ended', label: 'Закінчилось', color: 'gray' };
        const days = daysUntil(client.endDate);
        if (days <= 7) return { status: 'ending', label: `${days} дн до кінця`, color: 'amber' };
        return { status: 'active', label: `До ${formatDate(client.endDate)}`, color: 'green' };
      }
      
      if (type === 'deposit') {
        if (!client.startDate) return { status: 'waiting', label: 'Дата не визначена', color: 'gray' };
        if (isDatePast(client.startDate)) return { status: 'started', label: 'Розпочато', color: 'green' };
        const days = daysUntil(client.startDate);
        return { status: 'waiting', label: `Старт через ${days} дн`, color: 'amber' };
      }
      
      return { status: 'unknown', label: '', color: 'gray' };
    };

    // Firebase
    const clientsRef = () => collection(db, 'users', currentUser.uid, 'clients');
    const expensesRef = () => collection(db, 'users', currentUser.uid, 'expenses');
    const settingsDocRef = () => doc(db, 'users', currentUser.uid, 'settings', 'plan');

    const addClient = async (data) => await addDoc(clientsRef(), { ...data, createdAt: new Date().toISOString() });
    const updateClient = async (id, data) => await updateDoc(doc(db, 'users', currentUser.uid, 'clients', id), data);
    const deleteClient = async (id) => await deleteDoc(doc(db, 'users', currentUser.uid, 'clients', id));
    const addExpense = async (data) => await addDoc(expensesRef(), { ...data, createdAt: new Date().toISOString() });
    const updateExpense = async (id, data) => await updateDoc(doc(db, 'users', currentUser.uid, 'expenses', id), data);
    const deleteExpense = async (id) => await deleteDoc(doc(db, 'users', currentUser.uid, 'expenses', id));
    const saveSettings = async (data) => {
      const { setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      await setDoc(settingsDocRef(), data);
    };

    const handleSignIn = async () => { await signInWithPopup(auth, new GoogleAuthProvider()); };
    const handleSignOut = async () => { 
      if (unsubClients) unsubClients(); 
      if (unsubExpenses) unsubExpenses();
      if (unsubSettings) unsubSettings();
      await signOut(auth); 
    };

    const subscribeToData = () => {
      unsubClients = onSnapshot(query(clientsRef(), orderBy('createdAt', 'desc')), (snap) => {
        clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      });
      unsubExpenses = onSnapshot(query(expensesRef(), orderBy('date', 'desc')), (snap) => {
        expenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      });
      // Load settings
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(({ getDoc }) => {
        getDoc(settingsDocRef()).then(snap => {
          if (snap.exists()) {
            settings = snap.data();
            render();
          }
        });
      });
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) subscribeToData();
      else { clients = []; expenses = []; render(); }
    });

    // Render login
    const renderLogin = () => `
      <div class="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
          <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white">${icons.logo}</div>
          <h1 class="text-2xl font-bold text-gray-800 mb-2">TALKO CRM</h1>
          <p class="text-gray-500 mb-6">Облік клієнтів та фінансів</p>
          <button onclick="window.handleSignIn()" class="w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-xl hover:bg-gray-50">
            ${icons.google} <span>Увійти через Google</span>
          </button>
        </div>
      </div>
    `;

    // Render header
    const renderHeader = () => {
      const cm = getCurrentMonth();
      
      // Calculate totals
      let expectedThisMonth = 0;
      let paidThisMonth = 0;
      
      clients.forEach(c => {
        const type = getClientType(c);
        const clientStatus = c.clientStatus || 'active';
        if (clientStatus === 'archived') return;
        
        if (type === 'regular' && clientStatus === 'active' && !isOnAcademic(c)) {
          expectedThisMonth += getClientMonthlyAmount(c);
        }
        
        if (type === 'installment') {
          (c.payments || []).forEach(p => {
            if (p.date?.startsWith(cm)) {
              expectedThisMonth += p.amount || 0;
            }
          });
        }
        
        // Add paid amount
        paidThisMonth += getClientPaidAmount(c, cm);
      });
      
      const expensesThisMonth = expenses.filter(e => e.date?.startsWith(cm)).reduce((s, e) => s + (e.amount || 0), 0);

      return `
        <header class="bg-white border-b sticky top-0 z-40">
          <div class="max-w-5xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center text-white">${icons.logo}</div>
                <div>
                  <h1 class="font-bold text-gray-800">TALKO CRM</h1>
                  <div class="text-xs text-gray-500">${getMonthLabel(cm)}</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-3 text-sm">
                  <span title="Очікується" class="text-amber-600">€${(expectedThisMonth - paidThisMonth).toLocaleString()}</span>
                  <span title="Оплачено" class="text-green-600">+€${paidThisMonth.toLocaleString()}</span>
                  <span title="Витрати" class="text-red-600">-€${expensesThisMonth.toLocaleString()}</span>
                </div>
                <button onclick="window.exportToExcel()" class="p-2 text-gray-400 hover:text-green-600" title="Експорт в Excel">${icons.download}</button>
                <button onclick="window.openSettings()" class="p-2 text-gray-400 hover:text-blue-600" title="Налаштування плану">${icons.chart}</button>
                <button onclick="window.handleSignOut()" class="p-2 text-gray-400 hover:text-gray-600">${icons.logout}</button>
              </div>
            </div>
            <div class="flex gap-1 mt-3 -mb-3">
              <button onclick="window.setTab('clients')" class="px-4 py-2 rounded-t-lg text-sm font-medium flex items-center gap-1 ${activeTab === 'clients' ? 'bg-gray-100 text-green-600' : 'text-gray-500'}">
                ${icons.salary} Клієнти
              </button>
              <button onclick="window.setTab('expenses')" class="px-4 py-2 rounded-t-lg text-sm font-medium flex items-center gap-1 ${activeTab === 'expenses' ? 'bg-gray-100 text-red-600' : 'text-gray-500'}">
                ${icons.wallet} Витрати
              </button>
              <button onclick="window.setTab('finance')" class="px-4 py-2 rounded-t-lg text-sm font-medium flex items-center gap-1 ${activeTab === 'finance' ? 'bg-gray-100 text-blue-600' : 'text-gray-500'}">
                ${icons.chart} Фінанси
              </button>
            </div>
          </div>
        </header>
      `;
    };

    // Render clients
    const renderClients = () => {
      let filtered = clients;
      
      // Filter by client status first
      if (filterClientStatus) {
        filtered = filtered.filter(c => (c.clientStatus || 'active') === filterClientStatus);
      }
      
      // Filter new clients (this month)
      if (filterNewClients) {
        filtered = filtered.filter(c => isNewClientThisMonth(c));
      }
      
      if (filterSearch) {
        const s = filterSearch.toLowerCase();
        filtered = filtered.filter(c => c.name?.toLowerCase().includes(s) || c.businessName?.toLowerCase().includes(s));
      }
      if (filterType) {
        filtered = filtered.filter(c => getClientType(c) === filterType);
      }
      if (filterStatus) {
        if (filterStatus === 'academic') {
          filtered = filtered.filter(c => isOnAcademic(c));
        } else {
          filtered = filtered.filter(c => {
            const status = getClientStatus(c);
            return status.status === filterStatus;
          });
        }
      }

      // Build monthly entries
      const monthlyEntries = [];
      const cm = getCurrentMonth();
      
      filtered.forEach(c => {
        // Skip if on academic leave for regular clients in current month
        const onAcademic = isOnAcademic(c);
        const isPaused = (c.clientStatus || 'active') === 'paused';
        const isArchived = (c.clientStatus || 'active') === 'archived';
        const type = getClientType(c);
        
        if (type === 'regular') {
          if (isPaused || isArchived) {
            // Show in paused/archived group
            monthlyEntries.push({
              client: c,
              month: isPaused ? 'paused' : 'archived',
              date: null,
              amount: getClientMonthlyAmount(c),
              paid: false,
              type: 'regular',
              isPaused,
              isArchived
            });
          } else if (onAcademic) {
            // Show in academic group
            monthlyEntries.push({
              client: c,
              month: 'academic',
              date: c.academicTo,
              amount: getClientMonthlyAmount(c),
              paid: false,
              type: 'regular',
              isAcademic: true
            });
          } else {
            // Show in current month
            const paymentDate = getDayOfMonth(getClientPaymentDay(c));
            const paidThisMonth = isClientPaidThisMonth(c);
            monthlyEntries.push({
              client: c,
              month: cm,
              date: paymentDate,
              amount: getClientMonthlyAmount(c),
              paid: paidThisMonth,
              type: 'regular'
            });
          }
        }
        
        if (type === 'installment') {
          if (isPaused || isArchived) {
            // Show one entry in paused/archived group
            const nextPayment = (c.payments || []).find(p => !p.paid);
            if (nextPayment) {
              monthlyEntries.push({
                client: c,
                month: isPaused ? 'paused' : 'archived',
                date: nextPayment.date,
                amount: nextPayment.amount || 0,
                paid: false,
                paymentIndex: (c.payments || []).indexOf(nextPayment),
                type: 'installment',
                isPaused,
                isArchived
              });
            }
          } else {
            // Show each payment in its month (skip if on academic)
            (c.payments || []).forEach((p, idx) => {
              const month = p.date?.substring(0, 7) || cm;
              const isAcademicMonth = isMonthOnAcademic(c, month);
              
              if (isAcademicMonth && !p.paid) {
                // Show in academic group
                monthlyEntries.push({
                  client: c,
                  month: 'academic',
                  date: p.date,
                  amount: p.amount || 0,
                  paid: p.paid,
                  paymentIndex: idx,
                  type: 'installment',
                  isAcademic: true
                });
              } else {
                monthlyEntries.push({
                  client: c,
                  month: month,
                  date: p.date,
                  amount: p.amount || 0,
                  paid: p.paid,
                  paymentIndex: idx,
                  type: 'installment'
                });
              }
            });
          }
        }
        
        if (type === 'prepaid') {
          // Show in start month
          const month = c.startDate?.substring(0, 7) || cm;
          monthlyEntries.push({
            client: c,
            month: isPaused ? 'paused' : isArchived ? 'archived' : month,
            date: c.startDate,
            amount: c.totalAmount || c.amount || 0,
            paid: true,
            type: 'prepaid',
            isPaused,
            isArchived
          });
        }
        
        if (type === 'deposit') {
          // Show in planned start month or "no-date"
          const month = c.startDate?.substring(0, 7) || 'deposit';
          monthlyEntries.push({
            client: c,
            month: isPaused ? 'paused' : isArchived ? 'archived' : month,
            date: c.startDate,
            amount: c.depositAmount || c.paidAmount || 0,
            totalAmount: c.totalAmount || c.amount || 0,
            paid: false,
            type: 'deposit',
            isPaused,
            isArchived
          });
        }
      });

      // Group by month
      const groups = {};
      monthlyEntries.forEach(entry => {
        if (!groups[entry.month]) groups[entry.month] = [];
        groups[entry.month].push(entry);
      });

      // Sort entries within each month by date, then by status
      Object.values(groups).forEach(entries => {
        entries.sort((a, b) => {
          // Unpaid first
          if (a.paid !== b.paid) return a.paid ? 1 : -1;
          // Then by date
          return (a.date || '').localeCompare(b.date || '');
        });
      });

      // Sort months: paused first, then academic, then deposits, then reverse chronological, then archived last
      const sortedMonths = Object.keys(groups).sort((a, b) => {
        const order = { paused: 0, academic: 1, deposit: 2, archived: 999 };
        const aOrder = order[a] ?? 50;
        const bOrder = order[b] ?? 50;
        if (aOrder !== bOrder) return aOrder - bOrder;
        return b.localeCompare(a);
      });

      // Get all available months for filter
      const allMonths = sortedMonths.filter(m => !['deposit', 'academic', 'paused', 'archived'].includes(m));

      const filterPanel = `
        <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
          <!-- Client status tabs -->
          <div class="flex gap-1 mb-4 border-b">
            <button onclick="window.setFilter('clientStatus', 'active')" 
              class="px-4 py-2 text-sm font-medium border-b-2 ${filterClientStatus === 'active' && !filterNewClients ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              Активні
            </button>
            <button onclick="window.setFilter('newClients', true)" 
              class="px-4 py-2 text-sm font-medium border-b-2 flex items-center gap-1 ${filterNewClients ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              ${icons.star} Нові
              ${clients.filter(c => isNewClientThisMonth(c) && (c.clientStatus || 'active') === 'active').length > 0 ? 
                `<span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs">${clients.filter(c => isNewClientThisMonth(c) && (c.clientStatus || 'active') === 'active').length}</span>` : ''}
            </button>
            <button onclick="window.setFilter('clientStatus', 'paused')" 
              class="px-4 py-2 text-sm font-medium border-b-2 ${filterClientStatus === 'paused' ? 'border-gray-500 text-gray-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              На паузі
            </button>
            <button onclick="window.setFilter('clientStatus', 'archived')" 
              class="px-4 py-2 text-sm font-medium border-b-2 ${filterClientStatus === 'archived' ? 'border-gray-500 text-gray-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              Архів
            </button>
            <button onclick="window.setFilter('clientStatus', '')" 
              class="px-4 py-2 text-sm font-medium border-b-2 ${filterClientStatus === '' && !filterNewClients ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              Всі
            </button>
          </div>
          
          <div class="flex flex-wrap gap-3">
            <div class="flex-1 min-w-[200px] relative">
              <input type="text" placeholder="Пошук..." value="${filterSearch}" oninput="window.setFilter('search', this.value)"
                class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
              <span class="absolute left-3 top-2.5 text-gray-400">${icons.search}</span>
            </div>
            <select onchange="window.setFilter('month', this.value)" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Всі місяці</option>
              ${allMonths.map(m => `<option value="${m}" ${filterMonth === m ? 'selected' : ''}>${getMonthLabel(m)}</option>`).join('')}
            </select>
            <select onchange="window.setFilter('type', this.value)" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Всі типи</option>
              ${Object.entries(clientTypes).map(([k, v]) => `<option value="${k}" ${filterType === k ? 'selected' : ''}>${v.label}</option>`).join('')}
            </select>
            <select onchange="window.setFilter('status', this.value)" class="px-3 py-2 border rounded-lg text-sm">
              <option value="">Всі статуси</option>
              <option value="overdue" ${filterStatus === 'overdue' ? 'selected' : ''}>Прострочено</option>
              <option value="today" ${filterStatus === 'today' ? 'selected' : ''}>Сьогодні</option>
              <option value="soon" ${filterStatus === 'soon' ? 'selected' : ''}>Скоро</option>
              <option value="paid" ${filterStatus === 'paid' ? 'selected' : ''}>Оплачено</option>
              <option value="academic" ${filterStatus === 'academic' ? 'selected' : ''}>На академі</option>
            </select>
            ${(filterSearch || filterType || filterStatus || filterMonth) ? `<button onclick="window.clearFilters()" class="p-2 text-gray-400 hover:text-red-500">${icons.close}</button>` : ''}
          </div>
        </div>
      `;

      // Apply month filter
      const filteredMonths = filterMonth ? sortedMonths.filter(m => m === filterMonth || m === 'deposit') : sortedMonths;

      if (filteredMonths.length === 0 || (filterMonth && !groups[filterMonth])) {
        return filterPanel + `<div class="bg-white rounded-xl p-8 text-center text-gray-500">
          ${clients.length === 0 ? 'Немає клієнтів. Натисни "+" щоб додати.' : 'Нічого не знайдено.'}
        </div>`;
      }

      return filterPanel + filteredMonths.map(month => {
        const entries = groups[month];
        const isDeposits = month === 'deposit';
        const isAcademic = month === 'academic';
        const isPaused = month === 'paused';
        const isArchived = month === 'archived';
        const totalExpected = entries.filter(e => !e.paid && !e.isAcademic && !e.isPaused && !e.isArchived).reduce((s, e) => s + (e.amount || 0), 0);
        const totalPaid = entries.filter(e => e.paid).reduce((s, e) => s + (e.amount || 0), 0);

        let headerClass = 'bg-green-50';
        let headerIcon = icons.calendar;
        let headerTitle = getMonthLabel(month);
        
        if (isDeposits) {
          headerClass = 'bg-amber-50';
          headerIcon = icons.gift;
          headerTitle = 'Завдатки';
        } else if (isAcademic) {
          headerClass = 'bg-gray-100';
          headerIcon = icons.pause;
          headerTitle = 'Академічна відпустка';
        } else if (isPaused) {
          headerClass = 'bg-gray-100';
          headerIcon = icons.pause;
          headerTitle = 'На паузі (невідомо чи повернеться)';
        } else if (isArchived) {
          headerClass = 'bg-gray-50';
          headerIcon = icons.box;
          headerTitle = 'Архів';
        }

        return `
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4 ${isArchived ? 'opacity-60' : ''}">
            <div class="${headerClass} px-4 py-3 flex flex-wrap items-center justify-between gap-2">
              <h3 class="font-bold text-gray-800 flex items-center gap-2">
                ${headerIcon} ${headerTitle}
              </h3>
              <div class="flex gap-4 text-sm">
                ${isDeposits ? `
                  <span>Всього: <b class="text-amber-600">€${entries.reduce((s, e) => s + (e.totalAmount || e.amount || 0), 0).toLocaleString()}</b></span>
                ` : isAcademic || isPaused ? `
                  <span class="text-gray-500">${entries.length} клієнт(ів)</span>
                ` : isArchived ? `
                  <span class="text-gray-400">${entries.length} клієнт(ів)</span>
                ` : `
                  <span>Очікується: <b class="text-amber-600">€${totalExpected.toLocaleString()}</b></span>
                  <span>Оплачено: <b class="text-green-600">€${totalPaid.toLocaleString()}</b></span>
                `}
              </div>
            </div>
            <div class="divide-y">
              ${entries.map(entry => renderClientRow(entry)).join('')}
            </div>
          </div>
        `;
      }).join('');
    };

    const renderClientRow = (entry) => {
      const c = entry.client;
      const type = clientTypes[getClientType(c)] || clientTypes.regular;
      const clientStatus = c.clientStatus || 'active';
      const isPaused = clientStatus === 'paused';
      const isArchived = clientStatus === 'archived';
      const isPastDue = !entry.paid && !entry.isAcademic && !isPaused && !isArchived && entry.date && isDatePast(entry.date);
      const isToday = !entry.isAcademic && !isPaused && !isArchived && entry.date && isDateToday(entry.date);
      
      let statusBadge = '';
      let amountClass = '';
      let rowBg = '';
      
      if (isPaused) {
        statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-600 flex items-center gap-1">${icons.pause} На паузі</span>`;
        amountClass = 'text-gray-400';
        rowBg = 'bg-gray-50';
      } else if (isArchived) {
        statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-500">${icons.box} Архів</span>`;
        amountClass = 'text-gray-400';
        rowBg = 'bg-gray-50';
      } else if (entry.isAcademic) {
        statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-600 flex items-center gap-1">${icons.pause} До ${formatDate(c.academicTo)}</span>`;
        amountClass = 'text-gray-400';
        rowBg = 'bg-gray-50';
      } else if (entry.paid) {
        statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-700">Оплачено</span>`;
        amountClass = 'text-green-600';
      } else if (isPastDue) {
        statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700">Прострочено</span>`;
        amountClass = 'text-red-600';
        rowBg = 'bg-red-50';
      } else if (isToday) {
        statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-orange-100 text-orange-700">Сьогодні!</span>`;
        amountClass = 'text-orange-600';
        rowBg = 'bg-orange-50';
      } else {
        const days = daysUntil(entry.date);
        if (days <= 3 && days > 0) {
          statusBadge = `<span class="px-2 py-0.5 rounded text-xs bg-amber-100 text-amber-700">Через ${days} дн</span>`;
        }
        amountClass = 'text-gray-800';
      }

      const isInactive = isPaused || isArchived || entry.isAcademic;

      return `
        <div class="px-4 py-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer ${rowBg}" 
          onclick="window.viewClient('${c.id}')">
          <div class="w-8 h-8 rounded-full bg-${type.color}-100 text-${type.color}-600 flex items-center justify-center text-sm ${isInactive ? 'opacity-50' : ''}">
            ${type.icon}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-medium text-gray-800 ${isInactive ? 'text-gray-500' : ''} flex items-center gap-2">
              ${c.name}
              ${isNewClientThisMonth(c) && !isInactive ? `<span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">${icons.star}</span>` : ''}
            </div>
            <div class="text-sm text-gray-500 flex items-center gap-2">
              ${c.businessName ? `<span>${c.businessName}</span>` : ''}
              ${entry.date && entry.type !== 'deposit' && !isInactive ? `<span class="${isPastDue ? 'text-red-600' : ''}">${formatDate(entry.date)}</span>` : ''}
            </div>
          </div>
          ${statusBadge}
          <div class="text-right">
            <div class="font-bold ${amountClass}">€${(entry.amount || 0).toLocaleString()}</div>
            ${entry.type === 'deposit' ? `<div class="text-xs text-gray-500">з €${entry.totalAmount?.toLocaleString()}</div>` : ''}
            ${entry.type === 'installment' && !isInactive ? `<div class="text-xs text-gray-500">${entry.paymentIndex + 1}/${c.payments?.length || 0}</div>` : ''}
          </div>
          ${entry.type === 'regular' && !isInactive ? `
            <button onclick="event.stopPropagation(); ${entry.paid ? `window.cancelPaymentQuick('${c.id}')` : `window.quickMarkPaid('${c.id}')`}" 
              class="p-2 ${entry.paid ? 'text-green-500 hover:text-red-500' : 'text-gray-400 hover:text-green-500'}" 
              title="${entry.paid ? 'Скасувати оплату' : 'Оплачено'}">
              ${entry.paid ? icons.check : icons.check}
            </button>
          ` : ''}
          ${entry.type === 'installment' && !isInactive ? `
            <button onclick="event.stopPropagation(); window.toggleInstallmentPayment('${c.id}', ${entry.paymentIndex})" 
              class="p-2 ${entry.paid ? 'text-green-500 hover:text-red-500' : 'text-gray-400 hover:text-green-500'}" 
              title="${entry.paid ? 'Скасувати оплату' : 'Оплачено'}">
              ${icons.check}
            </button>
          ` : ''}
        </div>
      `;
    };

    // Render client card
    const renderClientCard = () => {
      if (!viewingClient) return '';
      const c = viewingClient;
      const type = clientTypes[getClientType(c)] || clientTypes.regular;
      const clientType = getClientType(c);
      const status = getClientStatus(c);
      const clientStatus = clientStatuses[c.clientStatus || 'active'];
      const cm = getCurrentMonth();

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) window.closeCard()">
          <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="bg-${type.color}-500 text-white p-4 rounded-t-2xl">
              <div class="flex justify-between items-start">
                <div>
                  <div class="flex items-center gap-2">
                    <span class="text-${type.color}-200 text-sm flex items-center gap-1">${type.icon} ${type.label}</span>
                    ${(c.clientStatus || 'active') !== 'active' ? `
                      <span class="px-2 py-0.5 rounded text-xs bg-white/20">${clientStatus.label}</span>
                    ` : ''}
                  </div>
                  <h2 class="text-xl font-bold mt-1">${c.name}</h2>
                  ${c.businessName ? `<div class="text-${type.color}-100">${c.businessName}</div>` : ''}
                </div>
                <button onclick="window.closeCard()" class="p-1 hover:bg-white/20 rounded">${icons.close}</button>
              </div>
            </div>
            
            <div class="p-4 space-y-4">
              <!-- Contacts -->
              ${(c.phone || c.email || c.telegram) ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Контакти</div>
                  <div class="space-y-2">
                    ${c.phone ? `<a href="tel:${c.phone}" class="flex items-center gap-2 text-gray-700 hover:text-green-600">${icons.phone} ${c.phone}</a>` : ''}
                    ${c.email ? `<a href="mailto:${c.email}" class="flex items-center gap-2 text-gray-700 hover:text-green-600">${icons.mail} ${c.email}</a>` : ''}
                    ${c.telegram ? `<a href="https://t.me/${c.telegram.replace('@','')}" target="_blank" class="flex items-center gap-2 text-gray-700 hover:text-green-600">${icons.send} ${c.telegram}</a>` : ''}
                  </div>
                </div>
              ` : ''}

              <!-- Info -->
              ${(c.city || c.serviceType || getClientSince(c)) ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Інформація</div>
                  <div class="space-y-1 text-sm">
                    ${c.city ? `<div class="flex items-center gap-2">${icons.mapPin} ${c.city}</div>` : ''}
                    ${c.serviceType ? `<div class="flex items-center gap-2">${icons.building} ${serviceTypes.find(s => s.value === c.serviceType)?.label || c.serviceType}</div>` : ''}
                    ${getClientSince(c) ? `
                      <div class="flex items-center gap-2">
                        ${icons.calendar} Клієнт з ${formatDate(getClientSince(c))}
                        ${isNewClientThisMonth(c) ? `<span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">Новий</span>` : ''}
                      </div>
                    ` : ''}
                  </div>
                </div>
              ` : ''}

              <!-- Type-specific info -->
              ${clientType === 'regular' ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Щомісячний платіж</div>
                  <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                      <span class="text-2xl font-bold text-blue-700">€${getClientMonthlyAmount(c).toLocaleString()}</span>
                      <span class="text-blue-600">${getClientPaymentDay(c)}-го числа</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span>Статус ${getMonthLabel(cm)}:</span>
                      <span class="font-bold ${status.status === 'paid' ? 'text-green-600' : status.status === 'overdue' ? 'text-red-600' : 'text-amber-600'}">${status.label}</span>
                    </div>
                    ${status.status !== 'paid' ? `
                      <button onclick="window.markPaid('${c.id}')" class="w-full mt-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        ${icons.check} Позначити оплаченим
                      </button>
                    ` : `
                      <button onclick="window.cancelPayment('${c.id}')" class="w-full mt-3 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-red-100 hover:text-red-600 flex items-center justify-center gap-2">
                        ${icons.close} Скасувати оплату
                      </button>
                    `}
                  </div>
                </div>
                
                <!-- Payment history -->
                ${(c.paymentHistory || []).length > 0 ? `
                  <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-2">Історія оплат</div>
                    <div class="space-y-1 max-h-32 overflow-y-auto">
                      ${(c.paymentHistory || []).slice().reverse().map(p => `
                        <div class="flex justify-between text-sm py-1 border-b">
                          <span>${getMonthLabel(p.month)}</span>
                          <span class="text-green-600">€${p.amount?.toLocaleString() || 0} — ${formatDate(p.paidAt)}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                <!-- Tariff history -->
                ${(c.tariffHistory || []).length > 0 ? `
                  <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-2">Історія тарифів</div>
                    <div class="space-y-1">
                      ${(c.tariffHistory || []).slice().reverse().map(t => `
                        <div class="flex justify-between text-sm py-1 border-b text-gray-600">
                          <span>${t.from ? formatDate(t.from) : '?'} — ${t.to ? formatDate(t.to) : '?'}</span>
                          <span>€${t.amount?.toLocaleString()}/міс</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              ` : ''}

              ${clientType === 'installment' ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Графік платежів</div>
                  <div class="space-y-2">
                    ${(c.payments || []).map((p, idx) => `
                      <div class="flex items-center gap-3 p-2 rounded-lg ${p.paid ? 'bg-green-50' : isDatePast(p.date) ? 'bg-red-50' : 'bg-gray-50'}">
                        <button onclick="window.toggleInstallmentPayment('${c.id}', ${idx})" 
                          class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${p.paid ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-500'}">
                          ${p.paid ? icons.check : ''}
                        </button>
                        <div class="flex-1">
                          <span class="${isDatePast(p.date) && !p.paid ? 'text-red-600' : ''}">${formatDate(p.date)}</span>
                        </div>
                        <span class="font-bold ${p.paid ? 'text-green-600' : ''}">€${(p.amount || 0).toLocaleString()}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              ${clientType === 'prepaid' ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Передоплата</div>
                  <div class="bg-green-50 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between">
                      <span>Сума:</span>
                      <span class="font-bold">€${(c.totalAmount || 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Період:</span>
                      <span>${formatDate(c.startDate)} — ${formatDate(c.endDate)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Статус:</span>
                      <span class="font-bold ${status.color === 'green' ? 'text-green-600' : 'text-amber-600'}">${status.label}</span>
                    </div>
                  </div>
                </div>
              ` : ''}

              ${clientType === 'deposit' ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Завдаток</div>
                  <div class="bg-amber-50 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between">
                      <span>Сума договору:</span>
                      <span class="font-bold">€${(c.totalAmount || 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Завдаток:</span>
                      <span class="font-bold text-green-600">€${(c.depositAmount || 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Залишок:</span>
                      <span class="font-bold text-amber-600">€${((c.totalAmount || 0) - (c.depositAmount || 0)).toLocaleString()}</span>
                    </div>
                    ${c.startDate ? `
                      <div class="flex justify-between">
                        <span>Дата старту:</span>
                        <span>${formatDate(c.startDate)}</span>
                      </div>
                    ` : `<div class="text-amber-600 text-sm">Дата старту не визначена</div>`}
                  </div>
                </div>
              ` : ''}

              <!-- Terms -->
              ${c.terms ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Умови та домовленості</div>
                  <div class="bg-yellow-50 rounded-lg p-3 text-sm whitespace-pre-wrap">${c.terms}</div>
                </div>
              ` : ''}

              <!-- Academic leave -->
              ${c.academicFrom ? `
                <div>
                  <div class="text-xs font-bold text-gray-500 uppercase mb-2">Академічна відпустка</div>
                  <div class="bg-gray-100 rounded-lg p-3 flex items-center gap-3">
                    <span class="text-gray-600">${icons.pause}</span>
                    <div>
                      <div class="font-medium ${isOnAcademic(c) ? 'text-orange-600' : 'text-gray-600'}">
                        ${isOnAcademic(c) ? 'Зараз на паузі' : 'Запланована пауза'}
                      </div>
                      <div class="text-sm text-gray-500">
                        ${formatDate(c.academicFrom)} — ${formatDate(c.academicTo)}
                      </div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>

            <div class="p-4 border-t space-y-3">
              <!-- Quick status change -->
              ${(c.clientStatus || 'active') === 'active' ? `
                <div class="flex gap-2">
                  <button onclick="window.setClientStatus('${c.id}', 'paused')" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2 text-sm">
                    ${icons.pause} Поставити на паузу
                  </button>
                  <button onclick="window.setClientStatus('${c.id}', 'archived')" class="py-2 px-3 bg-gray-100 text-gray-500 rounded-lg hover:bg-gray-200 text-sm">
                    В архів
                  </button>
                </div>
              ` : `
                <button onclick="window.setClientStatus('${c.id}', 'active')" class="w-full py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 flex items-center justify-center gap-2">
                  ${icons.check} Активувати клієнта
                </button>
              `}
              
              <div class="flex gap-2">
                <button onclick="window.editClient('${c.id}')" class="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">${icons.edit} Редагувати</button>
                <button onclick="window.deleteClientConfirm('${c.id}')" class="py-2 px-4 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">${icons.trash}</button>
              </div>
            </div>
          </div>
        </div>
      `;
    };

    // Render form
    const renderForm = () => {
      if (!showForm && !editingClient) return '';
      const isEdit = !!editingClient;
      const c = editingClient || { type: 'regular', name: '', phone: '', email: '', telegram: '', businessName: '', city: '', serviceType: '', terms: '' };

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) window.closeForm()">
          <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-2xl">
              <h3 class="text-lg font-bold">${isEdit ? 'Редагувати клієнта' : 'Новий клієнт'}</h3>
              <button onclick="window.closeForm()" class="p-1 text-gray-400">${icons.close}</button>
            </div>
            
            <form onsubmit="window.saveClient(event)" class="p-4 space-y-4">
              <!-- Client type -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Тип клієнта</label>
                <div class="grid grid-cols-2 gap-2">
                  ${Object.entries(clientTypes).map(([k, v]) => `
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${c.type === k ? `border-${v.color}-500 bg-${v.color}-50` : ''}">
                      <input type="radio" name="type" value="${k}" ${c.type === k ? 'checked' : ''} onchange="window.updateFormType('${k}')" class="hidden">
                      <span class="text-${v.color}-600">${v.icon}</span>
                      <div>
                        <div class="font-medium text-sm">${v.label}</div>
                        <div class="text-xs text-gray-500">${v.description}</div>
                      </div>
                    </label>
                  `).join('')}
                </div>
              </div>

              <!-- Client status -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Статус клієнта</label>
                <div class="flex gap-2">
                  ${Object.entries(clientStatuses).map(([k, v]) => `
                    <label class="flex-1 flex items-center justify-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50 ${(c.clientStatus || 'active') === k ? `border-${v.color}-500 bg-${v.color}-50` : ''}">
                      <input type="radio" name="clientStatus" value="${k}" ${(c.clientStatus || 'active') === k ? 'checked' : ''} class="hidden">
                      <span class="text-${v.color}-600">${v.icon}</span>
                      <span class="text-sm">${v.label}</span>
                    </label>
                  `).join('')}
                </div>
              </div>

              <!-- Basic info -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Імʼя клієнта *</label>
                <input type="text" name="name" value="${c.name || ''}" required class="w-full px-3 py-2 border rounded-lg">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
                  <input type="tel" name="phone" value="${c.phone || ''}" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Telegram</label>
                  <input type="text" name="telegram" value="${c.telegram || ''}" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Бізнес</label>
                  <input type="text" name="businessName" value="${c.businessName || ''}" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Місто</label>
                  <input type="text" name="city" value="${c.city || ''}" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Тип послуги</label>
                  <select name="serviceType" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">Не вказано</option>
                    ${serviceTypes.map(s => `<option value="${s.value}" ${c.serviceType === s.value ? 'selected' : ''}>${s.label}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Клієнт з</label>
                  <input type="date" name="clientSince" value="${c.clientSince || getClientSince(c) || getToday()}" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>

              <!-- Type-specific fields -->
              <div id="typeFields" class="border-t pt-4 space-y-4">
                ${renderTypeFields(c)}
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Умови та домовленості</label>
                <textarea name="terms" rows="2" class="w-full px-3 py-2 border rounded-lg">${c.terms || ''}</textarea>
              </div>

              <!-- Academic leave -->
              <div class="border-t pt-4">
                <div class="flex items-center gap-2 mb-3">
                  <input type="checkbox" id="hasAcademic" ${c.academicFrom ? 'checked' : ''} 
                    onchange="document.getElementById('academicFields').style.display = this.checked ? 'block' : 'none'"
                    class="w-4 h-4 text-gray-600 rounded">
                  <label for="hasAcademic" class="text-sm font-medium text-gray-700 flex items-center gap-1">
                    ${icons.pause} Академічна відпустка
                  </label>
                </div>
                <div id="academicFields" style="${c.academicFrom ? '' : 'display:none'}" class="bg-gray-50 rounded-lg p-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-700 mb-1">З дати</label>
                      <input type="date" name="academicFrom" value="${c.academicFrom || ''}" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                      <label class="block text-sm text-gray-700 mb-1">По дату</label>
                      <input type="date" name="academicTo" value="${c.academicTo || ''}" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">Оплати за цей період будуть перенесені</p>
                </div>
              </div>

              <div class="flex gap-2 pt-4 border-t">
                <button type="submit" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600">${icons.check} Зберегти</button>
                <button type="button" onclick="window.closeForm()" class="flex-1 py-2 bg-gray-200 rounded-lg">Скасувати</button>
              </div>
            </form>
          </div>
        </div>
      `;
    };

    const renderTypeFields = (c) => {
      const type = c.type || 'regular';
      
      if (type === 'regular') {
        const tariffHistory = c.tariffHistory || [];
        return `
          <div class="bg-blue-50 rounded-lg p-4 space-y-4">
            <h4 class="font-medium text-blue-800">Щомісячний платіж</h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-700 mb-1">Сума €/міс *</label>
                <input type="number" name="monthlyAmount" value="${c.monthlyAmount || ''}" required class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm text-gray-700 mb-1">День оплати *</label>
                <input type="number" name="paymentDay" min="1" max="31" value="${c.paymentDay || ''}" required class="w-full px-3 py-2 border rounded-lg" placeholder="1-31">
              </div>
            </div>
            ${tariffHistory.length > 0 ? `
              <div class="border-t pt-3">
                <div class="text-xs font-medium text-gray-500 mb-2">Історія тарифів</div>
                <div class="space-y-1 text-sm">
                  ${tariffHistory.map(t => `
                    <div class="flex justify-between text-gray-600">
                      <span>${t.from ? formatDate(t.from) : '?'} — ${t.to ? formatDate(t.to) : '?'}</span>
                      <span>€${t.amount?.toLocaleString()}/міс</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            <div class="border-t pt-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="changeTariff" onchange="document.getElementById('tariffChangeFields').style.display = this.checked ? 'block' : 'none'" class="rounded">
                <span class="text-sm text-gray-700">Зафіксувати зміну тарифу</span>
              </label>
              <div id="tariffChangeFields" style="display:none" class="mt-3 p-3 bg-white rounded-lg space-y-3">
                <p class="text-xs text-gray-500">Попередній тариф буде збережено в історії</p>
                <div class="grid grid-cols-3 gap-2">
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Стара сума €</label>
                    <input type="number" name="oldTariffAmount" value="${c.monthlyAmount || ''}" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">З дати</label>
                    <input type="date" name="oldTariffFrom" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">По дату</label>
                    <input type="date" name="oldTariffTo" value="${getToday()}" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      if (type === 'installment') {
        const payments = c.payments || [{ date: '', amount: '' }];
        return `
          <div class="bg-purple-50 rounded-lg p-4 space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-medium text-purple-800">Графік платежів</h4>
              <button type="button" onclick="window.addPaymentRow()" class="text-purple-600 text-sm flex items-center gap-1">${icons.plus} Додати</button>
            </div>
            <div id="paymentsContainer" class="space-y-2">
              ${payments.map((p, idx) => `
                <div class="payment-row flex gap-2 items-center">
                  <input type="date" name="pDate_${idx}" value="${p.date || ''}" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                  <input type="number" name="pAmount_${idx}" value="${p.amount || ''}" placeholder="Сума €" class="w-28 px-3 py-2 border rounded-lg text-sm">
                  <label class="flex items-center gap-1">
                    <input type="checkbox" name="pPaid_${idx}" ${p.paid ? 'checked' : ''} class="rounded">
                    <span class="text-xs">Спл.</span>
                  </label>
                  ${idx > 0 ? `<button type="button" onclick="this.closest('.payment-row').remove()" class="p-1 text-gray-400 hover:text-red-500">${icons.trash}</button>` : '<div class="w-6"></div>'}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      if (type === 'prepaid') {
        return `
          <div class="bg-green-50 rounded-lg p-4 space-y-4">
            <h4 class="font-medium text-green-800">Передоплата</h4>
            <div>
              <label class="block text-sm text-gray-700 mb-1">Сума € *</label>
              <input type="number" name="totalAmount" value="${c.totalAmount || ''}" required class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-700 mb-1">Початок</label>
                <input type="date" name="startDate" value="${c.startDate || ''}" class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm text-gray-700 mb-1">Закінчення</label>
                <input type="date" name="endDate" value="${c.endDate || ''}" class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
        `;
      }
      
      if (type === 'deposit') {
        return `
          <div class="bg-amber-50 rounded-lg p-4 space-y-4">
            <h4 class="font-medium text-amber-800">Завдаток</h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-700 mb-1">Сума договору € *</label>
                <input type="number" name="totalAmount" value="${c.totalAmount || ''}" required class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm text-gray-700 mb-1">Завдаток €</label>
                <input type="number" name="depositAmount" value="${c.depositAmount || ''}" class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">Планова дата старту</label>
              <input type="date" name="startDate" value="${c.startDate || ''}" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
        `;
      }
      
      return '';
    };

    // Render expenses
    const renderExpenses = () => {
      const groups = {};
      expenses.forEach(e => {
        const m = e.date?.substring(0, 7) || 'no-date';
        if (!groups[m]) groups[m] = [];
        groups[m].push(e);
      });

      const sortedMonths = Object.keys(groups).sort((a, b) => b.localeCompare(a));
      
      if (sortedMonths.length === 0) {
        return `<div class="bg-white rounded-xl p-8 text-center text-gray-500">Немає витрат.</div>`;
      }

      return sortedMonths.map(month => {
        const items = groups[month];
        const total = items.reduce((s, e) => s + (e.amount || 0), 0);
        
        return `
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4">
            <div class="bg-red-50 px-4 py-3 flex justify-between">
              <h3 class="font-bold">${icons.calendar} ${month === 'no-date' ? 'Без дати' : getMonthLabel(month)}</h3>
              <span class="text-red-600 font-bold">€${total.toLocaleString()}</span>
            </div>
            <div class="divide-y">
              ${items.map(e => {
                const cat = expenseCategories.find(c => c.value === e.category);
                return `
                  <div class="px-4 py-3 flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg bg-red-100 text-red-600 flex items-center justify-center">${icons[cat?.icon] || icons.box}</div>
                    <div class="flex-1">
                      <div class="font-medium">${e.description}</div>
                      <div class="text-sm text-gray-500">${formatDate(e.date)}</div>
                    </div>
                    <div class="font-bold text-red-600">-€${e.amount?.toLocaleString()}</div>
                    <button onclick="window.editExpense('${e.id}')" class="p-2 text-gray-400 hover:text-blue-500">${icons.edit}</button>
                    <button onclick="window.deleteExpenseConfirm('${e.id}')" class="p-2 text-gray-400 hover:text-red-500">${icons.trash}</button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    };

    // Render expense form
    const renderExpenseForm = () => {
      if (!showExpenseForm && !editingExpense) return '';
      const e = editingExpense || { description: '', date: getToday(), category: 'other', amount: '' };

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) window.closeExpenseForm()">
          <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between mb-4">
              <h3 class="text-lg font-bold">${editingExpense ? 'Редагувати' : 'Нова витрата'}</h3>
              <button onclick="window.closeExpenseForm()" class="text-gray-400">${icons.close}</button>
            </div>
            <form onsubmit="window.saveExpense(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Опис *</label>
                <input type="text" name="description" value="${e.description}" required class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Дата</label>
                  <input type="date" name="date" value="${e.date}" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Сума € *</label>
                  <input type="number" name="amount" value="${e.amount}" required class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Категорія</label>
                <select name="category" class="w-full px-3 py-2 border rounded-lg">
                  ${expenseCategories.map(c => `<option value="${c.value}" ${e.category === c.value ? 'selected' : ''}>${c.label}</option>`).join('')}
                </select>
              </div>
              <div class="flex gap-2 pt-4">
                <button type="submit" class="flex-1 py-2 bg-red-500 text-white rounded-lg">${icons.check} Зберегти</button>
                <button type="button" onclick="window.closeExpenseForm()" class="flex-1 py-2 bg-gray-200 rounded-lg">Скасувати</button>
              </div>
            </form>
          </div>
        </div>
      `;
    };

    // Render settings modal
    const renderSettings = () => {
      if (!showSettings) return '';

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) window.closeSettings()">
          <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between mb-4">
              <h3 class="text-lg font-bold flex items-center gap-2">${icons.chart} Налаштування плану</h3>
              <button onclick="window.closeSettings()" class="text-gray-400">${icons.close}</button>
            </div>
            <form onsubmit="window.saveSettingsForm(event)" class="space-y-4">
              <div class="bg-blue-50 rounded-lg p-4 space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">План на місяць €</label>
                  <input type="number" name="monthlyPlan" value="${settings.monthlyPlan || ''}" 
                    placeholder="Наприклад: 5000" class="w-full px-3 py-2 border rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">Скільки планую заробляти щомісяця</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">План на рік €</label>
                  <input type="number" name="yearlyPlan" value="${settings.yearlyPlan || ''}" 
                    placeholder="Наприклад: 60000" class="w-full px-3 py-2 border rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">Або автоматично: місячний × 12</p>
                </div>
              </div>
              <div class="flex gap-2 pt-4">
                <button type="submit" class="flex-1 py-2 bg-blue-500 text-white rounded-lg">${icons.check} Зберегти</button>
                <button type="button" onclick="window.closeSettings()" class="flex-1 py-2 bg-gray-200 rounded-lg">Скасувати</button>
              </div>
            </form>
          </div>
        </div>
      `;
    };

    // Render finance with chart
    const renderFinance = () => {
      const cm = getCurrentMonth();
      const currentYear = new Date().getFullYear();
      
      // Generate all months for current year
      const yearMonths = [];
      for (let m = 1; m <= 12; m++) {
        yearMonths.push(`${currentYear}-${String(m).padStart(2, '0')}`);
      }

      // Calculate plan and actual for each month
      const monthlyPlan = settings.monthlyPlan || 0;
      const yearlyPlan = settings.yearlyPlan || (monthlyPlan * 12);
      
      const monthlyData = yearMonths.map(month => {
        let actual = 0;

        clients.forEach(c => {
          // Add actual paid amount using helper
          actual += getClientPaidAmount(c, month);
        });

        // Expenses for this month
        const monthExpenses = expenses.filter(e => e.date?.startsWith(month)).reduce((s, e) => s + (e.amount || 0), 0);

        return { month, plan: monthlyPlan, actual, expenses: monthExpenses, profit: actual - monthExpenses };
      });

      // Totals
      const totals = {
        plan: yearlyPlan,
        actual: monthlyData.reduce((acc, m) => acc + m.actual, 0),
        expenses: monthlyData.reduce((acc, m) => acc + m.expenses, 0)
      };

      // Find max value for chart scaling
      const maxValue = Math.max(...monthlyData.map(m => Math.max(m.plan, m.actual, m.expenses)), 1);

      // Month labels
      const monthLabels = ['Січ', 'Лют', 'Бер', 'Кві', 'Тра', 'Чер', 'Лип', 'Сер', 'Вер', 'Жов', 'Лис', 'Гру'];

      return `
        <!-- Plan settings prompt -->
        ${!monthlyPlan ? `
          <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 flex items-center justify-between">
            <div>
              <div class="font-medium text-amber-800">План не налаштовано</div>
              <div class="text-sm text-amber-600">Встановіть місячний план для відстеження прогресу</div>
            </div>
            <button onclick="window.openSettings()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
              Налаштувати
            </button>
          </div>
        ` : ''}

        <!-- Summary cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <div class="text-sm text-blue-600">План на рік</div>
            <div class="text-2xl font-bold text-blue-700">€${totals.plan.toLocaleString()}</div>
            ${monthlyPlan ? `<div class="text-xs text-blue-500">€${monthlyPlan.toLocaleString()}/міс</div>` : ''}
          </div>
          <div class="bg-green-50 rounded-xl p-4 text-center">
            <div class="text-sm text-green-600">Фактично отримано</div>
            <div class="text-2xl font-bold text-green-700">€${totals.actual.toLocaleString()}</div>
          </div>
          <div class="bg-red-50 rounded-xl p-4 text-center">
            <div class="text-sm text-red-600">Витрати</div>
            <div class="text-2xl font-bold text-red-700">€${totals.expenses.toLocaleString()}</div>
          </div>
          <div class="${totals.actual - totals.expenses >= 0 ? 'bg-emerald-50' : 'bg-orange-50'} rounded-xl p-4 text-center">
            <div class="text-sm ${totals.actual - totals.expenses >= 0 ? 'text-emerald-600' : 'text-orange-600'}">Чистий прибуток</div>
            <div class="text-2xl font-bold ${totals.actual - totals.expenses >= 0 ? 'text-emerald-700' : 'text-orange-700'}">€${(totals.actual - totals.expenses).toLocaleString()}</div>
          </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-gray-800 flex items-center gap-2">${icons.chart} План vs Факт ${currentYear}</h3>
            <button onclick="window.openSettings()" class="text-sm text-blue-600 hover:underline">Змінити план</button>
          </div>
          
          <!-- Legend -->
          <div class="flex gap-6 mb-4 text-sm">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded bg-blue-200"></div>
              <span>План</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded bg-green-500"></div>
              <span>Факт</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded bg-red-400"></div>
              <span>Витрати</span>
            </div>
          </div>

          <!-- Bar chart -->
          <div class="relative">
            <!-- Y-axis labels -->
            <div class="absolute left-0 top-0 bottom-8 w-12 flex flex-col justify-between text-xs text-gray-400">
              <span>€${maxValue.toLocaleString()}</span>
              <span>€${Math.round(maxValue/2).toLocaleString()}</span>
              <span>€0</span>
            </div>
            
            <!-- Chart area -->
            <div class="ml-14 overflow-x-auto">
              <div class="flex gap-2 min-w-[600px]" style="height: 200px;">
                ${monthlyData.map((m, idx) => {
                  const planHeight = Math.round((m.plan / maxValue) * 100);
                  const actualHeight = Math.round((m.actual / maxValue) * 100);
                  const expenseHeight = Math.round((m.expenses / maxValue) * 100);
                  const isCurrentMonth = m.month === cm;
                  const isPast = m.month < cm;
                  
                  return `
                    <div class="flex-1 flex flex-col items-center justify-end ${isCurrentMonth ? 'bg-green-50 rounded-t-lg' : ''}">
                      <div class="w-full flex justify-center gap-1 items-end h-full pb-1">
                        <!-- Plan bar -->
                        <div class="w-5 bg-blue-200 rounded-t transition-all hover:bg-blue-300" 
                          style="height: ${planHeight}%;" 
                          title="План: €${m.plan.toLocaleString()}"></div>
                        <!-- Actual bar -->
                        <div class="w-5 ${m.actual >= m.plan ? 'bg-green-500' : 'bg-green-400'} rounded-t transition-all hover:bg-green-600" 
                          style="height: ${actualHeight}%;" 
                          title="Факт: €${m.actual.toLocaleString()}"></div>
                        <!-- Expenses bar -->
                        <div class="w-5 bg-red-400 rounded-t transition-all hover:bg-red-500" 
                          style="height: ${expenseHeight}%;" 
                          title="Витрати: €${m.expenses.toLocaleString()}"></div>
                      </div>
                      <div class="text-xs ${isCurrentMonth ? 'font-bold text-green-600' : isPast ? 'text-gray-400' : 'text-gray-500'} mt-1">
                        ${monthLabels[idx]}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>

        <!-- Progress bar -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-gray-600">Виконання плану</span>
            <span class="text-sm font-bold ${totals.actual >= totals.plan ? 'text-green-600' : 'text-amber-600'}">
              ${totals.plan > 0 ? Math.round((totals.actual / totals.plan) * 100) : 0}%
            </span>
          </div>
          <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
            <div class="h-full ${totals.actual >= totals.plan ? 'bg-green-500' : 'bg-amber-500'} rounded-full transition-all" 
              style="width: ${Math.min(100, totals.plan > 0 ? (totals.actual / totals.plan) * 100 : 0)}%"></div>
          </div>
          <div class="flex justify-between mt-1 text-xs text-gray-400">
            <span>€0</span>
            <span>€${totals.plan.toLocaleString()}</span>
          </div>
        </div>

        <!-- Monthly table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="px-4 py-3 bg-gray-50 border-b">
            <h3 class="font-bold text-gray-800">Деталі по місяцях</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">Місяць</th>
                  <th class="px-4 py-3 text-right">План</th>
                  <th class="px-4 py-3 text-right">Факт</th>
                  <th class="px-4 py-3 text-right">%</th>
                  <th class="px-4 py-3 text-right">Витрати</th>
                  <th class="px-4 py-3 text-right">Прибуток</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${monthlyData.map(m => {
                  const percent = m.plan > 0 ? Math.round((m.actual / m.plan) * 100) : 0;
                  const isCurrentMonth = m.month === cm;
                  const isPast = m.month < cm;
                  
                  return `
                    <tr class="${isCurrentMonth ? 'bg-green-50' : ''} ${!isPast && !isCurrentMonth ? 'text-gray-400' : ''}">
                      <td class="px-4 py-3 font-medium ${isCurrentMonth ? 'text-green-700' : ''}">${getMonthLabel(m.month)}</td>
                      <td class="px-4 py-3 text-right text-blue-600">€${m.plan.toLocaleString()}</td>
                      <td class="px-4 py-3 text-right text-green-600">€${m.actual.toLocaleString()}</td>
                      <td class="px-4 py-3 text-right">
                        <span class="px-2 py-0.5 rounded text-xs ${percent >= 100 ? 'bg-green-100 text-green-700' : percent >= 50 ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600'}">
                          ${percent}%
                        </span>
                      </td>
                      <td class="px-4 py-3 text-right text-red-600">€${m.expenses.toLocaleString()}</td>
                      <td class="px-4 py-3 text-right font-bold ${m.profit >= 0 ? 'text-emerald-600' : 'text-orange-600'}">
                        €${m.profit.toLocaleString()}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot class="bg-gray-50 font-bold">
                <tr>
                  <td class="px-4 py-3">Всього</td>
                  <td class="px-4 py-3 text-right text-blue-600">€${totals.plan.toLocaleString()}</td>
                  <td class="px-4 py-3 text-right text-green-600">€${totals.actual.toLocaleString()}</td>
                  <td class="px-4 py-3 text-right">
                    <span class="px-2 py-0.5 rounded text-xs ${totals.plan > 0 && (totals.actual / totals.plan) >= 1 ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
                      ${totals.plan > 0 ? Math.round((totals.actual / totals.plan) * 100) : 0}%
                    </span>
                  </td>
                  <td class="px-4 py-3 text-right text-red-600">€${totals.expenses.toLocaleString()}</td>
                  <td class="px-4 py-3 text-right ${totals.actual - totals.expenses >= 0 ? 'text-emerald-600' : 'text-orange-600'}">
                    €${(totals.actual - totals.expenses).toLocaleString()}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;
    };

    // Main render
    const render = () => {
      if (!currentUser) { document.getElementById('app').innerHTML = renderLogin(); return; }

      let content = '';
      let fab = '';
      
      if (activeTab === 'clients') {
        content = renderClients();
        fab = `<button onclick="window.openForm()" class="fixed bottom-6 right-6 w-14 h-14 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg flex items-center justify-center">${icons.plus}</button>`;
      } else if (activeTab === 'expenses') {
        content = renderExpenses();
        fab = `<button onclick="window.openExpenseForm()" class="fixed bottom-6 right-6 w-14 h-14 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center">${icons.plus}</button>`;
      } else {
        content = renderFinance();
      }

      document.getElementById('app').innerHTML = `
        ${renderHeader()}
        <main class="max-w-5xl mx-auto px-4 py-4">${content}</main>
        ${fab}
        ${renderForm()}
        ${renderExpenseForm()}
        ${renderSettings()}
        ${renderClientCard()}
      `;
    };

    // Handlers
    window.handleSignIn = handleSignIn;
    window.handleSignOut = handleSignOut;
    window.setTab = (t) => { activeTab = t; render(); };
    window.setFilter = (type, val) => { 
      if (type === 'search') filterSearch = val;
      if (type === 'type') filterType = val;
      if (type === 'status') filterStatus = val;
      if (type === 'month') filterMonth = val;
      if (type === 'clientStatus') { filterClientStatus = val; filterNewClients = false; }
      if (type === 'newClients') { filterNewClients = val; filterClientStatus = 'active'; }
      render(); 
    };
    window.clearFilters = () => { filterSearch = ''; filterType = ''; filterStatus = ''; filterMonth = ''; filterNewClients = false; render(); };

    window.openForm = () => { showForm = true; editingClient = null; render(); };
    window.closeForm = () => { showForm = false; editingClient = null; render(); };
    window.editClient = (id) => { editingClient = clients.find(c => c.id === id); viewingClient = null; render(); };
    window.viewClient = (id) => { viewingClient = clients.find(c => c.id === id); render(); };
    window.closeCard = () => { viewingClient = null; render(); };
    window.deleteClientConfirm = async (id) => { if (confirm('Видалити клієнта?')) { await deleteClient(id); viewingClient = null; render(); } };

    window.openExpenseForm = () => { showExpenseForm = true; editingExpense = null; render(); };
    window.closeExpenseForm = () => { showExpenseForm = false; editingExpense = null; render(); };
    window.editExpense = (id) => { editingExpense = expenses.find(e => e.id === id); render(); };
    window.deleteExpenseConfirm = async (id) => { if (confirm('Видалити?')) await deleteExpense(id); };

    window.openSettings = () => { showSettings = true; render(); };
    window.closeSettings = () => { showSettings = false; render(); };
    window.saveSettingsForm = async (e) => {
      e.preventDefault();
      const f = e.target;
      const monthlyPlan = parseFloat(f.monthlyPlan.value) || 0;
      const yearlyPlan = parseFloat(f.yearlyPlan.value) || (monthlyPlan * 12);
      settings = { monthlyPlan, yearlyPlan };
      await saveSettings(settings);
      showSettings = false;
      render();
    };

    window.updateFormType = (type) => {
      const container = document.getElementById('typeFields');
      if (container) container.innerHTML = renderTypeFields({ type });
    };

    window.addPaymentRow = () => {
      const container = document.getElementById('paymentsContainer');
      const idx = container.querySelectorAll('.payment-row').length;
      const div = document.createElement('div');
      div.className = 'payment-row flex gap-2 items-center';
      div.innerHTML = `
        <input type="date" name="pDate_${idx}" class="flex-1 px-3 py-2 border rounded-lg text-sm">
        <input type="number" name="pAmount_${idx}" placeholder="Сума €" class="w-28 px-3 py-2 border rounded-lg text-sm">
        <label class="flex items-center gap-1">
          <input type="checkbox" name="pPaid_${idx}" class="rounded">
          <span class="text-xs">Спл.</span>
        </label>
        <button type="button" onclick="this.closest('.payment-row').remove()" class="p-1 text-gray-400 hover:text-red-500">${icons.trash}</button>
      `;
      container.appendChild(div);
    };

    window.saveClient = async (e) => {
      e.preventDefault();
      const f = e.target;
      const type = f.type.value;
      
      const data = {
        type,
        clientStatus: f.clientStatus.value || 'active',
        name: f.name.value,
        phone: f.phone.value,
        telegram: f.telegram.value,
        businessName: f.businessName.value,
        city: f.city.value,
        serviceType: f.serviceType.value,
        terms: f.terms.value,
        clientSince: f.clientSince?.value || editingClient?.clientSince || getToday(),
        academicFrom: f.academicFrom?.value || '',
        academicTo: f.academicTo?.value || '',
      };

      if (type === 'regular') {
        data.monthlyAmount = parseFloat(f.monthlyAmount.value) || 0;
        data.paymentDay = parseInt(f.paymentDay.value) || 1;
        data.paymentHistory = editingClient?.paymentHistory || [];
        data.tariffHistory = editingClient?.tariffHistory || [];
        
        // Check if tariff change was logged
        if (f.changeTariff?.checked && f.oldTariffAmount?.value) {
          data.tariffHistory.push({
            amount: parseFloat(f.oldTariffAmount.value) || 0,
            from: f.oldTariffFrom?.value || '',
            to: f.oldTariffTo?.value || getToday()
          });
        }
      }
      
      if (type === 'installment') {
        const payments = [];
        f.querySelectorAll('.payment-row').forEach((row, idx) => {
          const date = f[`pDate_${idx}`]?.value;
          const amount = parseFloat(f[`pAmount_${idx}`]?.value) || 0;
          const paid = f[`pPaid_${idx}`]?.checked || false;
          if (date || amount) payments.push({ date, amount, paid });
        });
        data.payments = payments.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
      }
      
      if (type === 'prepaid') {
        data.totalAmount = parseFloat(f.totalAmount.value) || 0;
        data.startDate = f.startDate.value;
        data.endDate = f.endDate.value;
      }
      
      if (type === 'deposit') {
        data.totalAmount = parseFloat(f.totalAmount.value) || 0;
        data.depositAmount = parseFloat(f.depositAmount.value) || 0;
        data.startDate = f.startDate.value;
      }

      if (editingClient) await updateClient(editingClient.id, data);
      else await addClient(data);
      
      showForm = false;
      editingClient = null;
      render();
    };

    window.saveExpense = async (e) => {
      e.preventDefault();
      const f = e.target;
      const data = { description: f.description.value, date: f.date.value, category: f.category.value, amount: parseFloat(f.amount.value) || 0 };
      if (editingExpense) await updateExpense(editingExpense.id, data);
      else await addExpense(data);
      showExpenseForm = false;
      editingExpense = null;
      render();
    };

    window.markPaid = async (id) => {
      const client = clients.find(c => c.id === id);
      if (!client) return;
      
      const cm = getCurrentMonth();
      const history = client.paymentHistory || [];
      history.push({ month: cm, amount: client.monthlyAmount, paidAt: getToday() });
      
      await updateClient(id, { paymentHistory: history });
      viewingClient = { ...viewingClient, paymentHistory: history };
      render();
    };

    window.quickMarkPaid = async (id) => {
      const client = clients.find(c => c.id === id);
      if (!client) return;
      
      const cm = getCurrentMonth();
      const history = client.paymentHistory || [];
      
      // Check if already paid this month
      if (history.some(p => p.month === cm)) return;
      
      history.push({ month: cm, amount: client.monthlyAmount, paidAt: getToday() });
      await updateClient(id, { paymentHistory: history });
    };

    window.cancelPayment = async (id) => {
      const client = clients.find(c => c.id === id);
      if (!client) return;
      
      const cm = getCurrentMonth();
      const history = (client.paymentHistory || []).filter(p => p.month !== cm);
      
      await updateClient(id, { paymentHistory: history });
      viewingClient = { ...viewingClient, paymentHistory: history };
      render();
    };

    window.cancelPaymentQuick = async (id) => {
      const client = clients.find(c => c.id === id);
      if (!client) return;
      
      const cm = getCurrentMonth();
      const history = (client.paymentHistory || []).filter(p => p.month !== cm);
      
      await updateClient(id, { paymentHistory: history });
    };

    window.setClientStatus = async (id, status) => {
      await updateClient(id, { clientStatus: status });
      viewingClient = { ...viewingClient, clientStatus: status };
      render();
    };

    // Export to Excel
    window.exportToExcel = () => {
      const cm = getCurrentMonth();
      
      // Prepare clients data
      const clientsData = clients.map(c => {
        const type = clientTypes[c.type];
        const status = clientStatuses[c.clientStatus || 'active'];
        
        let amount = 0;
        let paidAmount = 0;
        
        if (c.type === 'regular') {
          amount = c.monthlyAmount || 0;
          const paidThisMonth = (c.paymentHistory || []).find(p => p.month === cm);
          paidAmount = paidThisMonth ? (paidThisMonth.amount || amount) : 0;
        } else if (c.type === 'installment') {
          amount = (c.payments || []).reduce((s, p) => s + (p.amount || 0), 0);
          paidAmount = (c.payments || []).filter(p => p.paid).reduce((s, p) => s + (p.amount || 0), 0);
        } else if (c.type === 'prepaid') {
          amount = c.totalAmount || 0;
          paidAmount = amount;
        } else if (c.type === 'deposit') {
          amount = c.totalAmount || 0;
          paidAmount = c.depositAmount || 0;
        }

        return {
          'Імʼя': c.name || '',
          'Бізнес': c.businessName || '',
          'Місто': c.city || '',
          'Телефон': c.phone || '',
          'Telegram': c.telegram || '',
          'Email': c.email || '',
          'Тип': type?.label || '',
          'Статус': status?.label || '',
          'Сума договору': amount,
          'Оплачено': paidAmount,
          'Залишок': amount - paidAmount,
          'День оплати': c.paymentDay || '',
          'Послуга': serviceTypes.find(s => s.value === c.serviceType)?.label || '',
          'Умови': c.terms || '',
          'Академ з': c.academicFrom || '',
          'Академ по': c.academicTo || '',
        };
      });

      // Prepare payments data (all payment history)
      const paymentsData = [];
      clients.forEach(c => {
        if (c.type === 'regular') {
          (c.paymentHistory || []).forEach(p => {
            paymentsData.push({
              'Клієнт': c.name,
              'Бізнес': c.businessName || '',
              'Місяць': getMonthLabel(p.month),
              'Дата оплати': p.paidAt || '',
              'Сума': p.amount || c.monthlyAmount || 0,
              'Тип': 'Регулярний',
            });
          });
        }
        if (c.type === 'installment') {
          (c.payments || []).forEach((p, idx) => {
            paymentsData.push({
              'Клієнт': c.name,
              'Бізнес': c.businessName || '',
              'Дата платежу': p.date || '',
              'Сума': p.amount || 0,
              'Оплачено': p.paid ? 'Так' : 'Ні',
              'Тип': `Розтермінування (${idx + 1}/${c.payments.length})`,
            });
          });
        }
      });

      // Prepare expenses data
      const expensesData = expenses.map(e => {
        const cat = expenseCategories.find(c => c.value === e.category);
        return {
          'Опис': e.description || '',
          'Дата': e.date || '',
          'Категорія': cat?.label || '',
          'Сума': e.amount || 0,
        };
      });

      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Add sheets
      const wsClients = XLSX.utils.json_to_sheet(clientsData);
      XLSX.utils.book_append_sheet(wb, wsClients, 'Клієнти');
      
      if (paymentsData.length > 0) {
        const wsPayments = XLSX.utils.json_to_sheet(paymentsData);
        XLSX.utils.book_append_sheet(wb, wsPayments, 'Оплати');
      }
      
      if (expensesData.length > 0) {
        const wsExpenses = XLSX.utils.json_to_sheet(expensesData);
        XLSX.utils.book_append_sheet(wb, wsExpenses, 'Витрати');
      }

      // Generate filename with date
      const today = getToday().replace(/-/g, '');
      XLSX.writeFile(wb, `TALKO_CRM_${today}.xlsx`);
    };

    window.exportClientsCSV = () => {
      const rows = [['Імʼя', 'Бізнес', 'Телефон', 'Telegram', 'Тип', 'Сума', 'Статус']];
      
      clients.forEach(c => {
        const type = clientTypes[c.type];
        const status = clientStatuses[c.clientStatus || 'active'];
        let amount = c.monthlyAmount || c.totalAmount || 0;
        
        rows.push([
          c.name || '',
          c.businessName || '',
          c.phone || '',
          c.telegram || '',
          type?.label || '',
          amount,
          status?.label || ''
        ]);
      });

      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `TALKO_Clients_${getToday()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.toggleInstallmentPayment = async (id, idx) => {
      const client = clients.find(c => c.id === id);
      if (!client) return;
      
      const payments = [...(client.payments || [])];
      payments[idx] = { ...payments[idx], paid: !payments[idx].paid };
      
      await updateClient(id, { payments });
      viewingClient = { ...viewingClient, payments };
      render();
    };

    render();
  </script>
</head>
<body><div id="app"></div></body>
</html>
